(function(p,w){typeof exports=="object"&&typeof module!="undefined"?module.exports=w():typeof define=="function"&&define.amd?define(w):(p=typeof globalThis!="undefined"?globalThis:p||self,p.DomToPip=w())})(this,function(){"use strict";var p=globalThis&&globalThis.__awaiter||function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(c){c(o)})}return new(n||(n=Promise))(function(o,c){function l(s){try{u(r.next(s))}catch(a){c(a)}}function f(s){try{u(r.throw(s))}catch(a){c(a)}}function u(s){s.done?o(s.value):i(s.value).then(l,f)}u((r=r.apply(e,t||[])).next())})};const w="application/font-woff",L="image/jpeg",j={woff:w,woff2:w,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:L,jpeg:L,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"};function B(e){const t=/\.([^./]*?)$/g.exec(e);return t?t[1]:""}function v(e){const t=B(e).toLowerCase();return j[t]||""}function z(e,t){if(e.match(/^[a-z]+:\/\//i))return e;if(e.match(/^\/\//))return window.location.protocol+e;if(e.match(/^[a-z]+:/i))return e;const n=document.implementation.createHTMLDocument(),r=n.createElement("base"),i=n.createElement("a");return n.head.appendChild(r),n.body.appendChild(i),t&&(r.href=t),i.href=e,i.href}function T(e){return e.search(/^(data:)/)!==-1}function x(e,t){return`data:${t};base64,${e}`}function G(e){return e.split(/,/)[1]}const X=function(){let t=0;const n=()=>`0000${(Math.random()*Math.pow(36,4)<<0).toString(36)}`.slice(-4);return()=>(t+=1,`u${n()}${t}`)}();function m(e){const t=[];for(let n=0,r=e.length;n<r;n+=1)t.push(e[n]);return t}function S(e,t){const n=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(n.replace("px",""))}function q(e){const t=S(e,"border-left-width"),n=S(e,"border-right-width");return e.clientWidth+t+n}function K(e){const t=S(e,"border-top-width"),n=S(e,"border-bottom-width");return e.clientHeight+t+n}function J(){let e,t;try{t=process}catch{}const n=t&&t.env?t.env.devicePixelRatio:null;return n&&(e=parseInt(n,10),Number.isNaN(e)&&(e=1)),e||window.devicePixelRatio||1}function C(e){return new Promise((t,n)=>{const r=new Image;r.onload=()=>t(r),r.onerror=n,r.crossOrigin="anonymous",r.decoding="sync",r.src=e})}function Q(e){return p(this,void 0,void 0,function*(){return Promise.resolve().then(()=>new XMLSerializer().serializeToString(e)).then(encodeURIComponent).then(t=>`data:image/svg+xml;charset=utf-8,${t}`)})}function Y(e,t,n){return p(this,void 0,void 0,function*(){const r="http://www.w3.org/2000/svg",i=document.createElementNS(r,"svg"),o=document.createElementNS(r,"foreignObject");return i.setAttribute("width",`${t}`),i.setAttribute("height",`${n}`),i.setAttribute("viewBox",`0 0 ${t} ${n}`),o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.setAttribute("x","0"),o.setAttribute("y","0"),o.setAttribute("externalResourcesRequired","true"),i.appendChild(o),o.appendChild(e),Q(i)})}const R={};function Z(e){let t=e.replace(/\?.*/,"");return/ttf|otf|eot|woff2?/i.test(t)&&(t=t.replace(/.*\//,"")),t}function P(e,t){const n=Z(e);if(R[n]!=null)return R[n];t.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+new Date().getTime());const r=o=>{let c="";if(t.imagePlaceholder){const f=t.imagePlaceholder.split(/,/);f&&f[1]&&(c=f[1])}let l=`Failed to fetch resource: ${e}`;return o&&(l=typeof o=="string"?o:o.message),l&&console.error(l),{blob:c,contentType:""}},i=window.fetch(e).then(o=>o.blob().then(c=>({blob:c,contentType:o.headers.get("Content-Type")||""}))).then(({blob:o,contentType:c})=>new Promise((l,f)=>{const u=new FileReader;u.onloadend=()=>l({contentType:c,blob:u.result}),u.onerror=f,u.readAsDataURL(o)})).then(({blob:o,contentType:c})=>({contentType:c,blob:G(o)})).catch(r);return R[n]=i,i}function N(e){const t=e.getPropertyValue("content");return`${e.cssText} content: '${t.replace(/'|"/g,"")}';`}function ee(e){return m(e).map(t=>{const n=e.getPropertyValue(t),r=e.getPropertyPriority(t);return`${t}: ${n}${r?" !important":""};`}).join(" ")}function te(e,t,n){const r=`.${e}:${t}`,i=n.cssText?N(n):ee(n);return document.createTextNode(`${r}{${i}}`)}function I(e,t,n){const r=window.getComputedStyle(e,n),i=r.getPropertyValue("content");if(i===""||i==="none")return;const o=X();try{t.className=`${t.className} ${o}`}catch{return}const c=document.createElement("style");c.appendChild(te(o,n,r)),t.appendChild(c)}function ne(e,t){I(e,t,":before"),I(e,t,":after")}var b=globalThis&&globalThis.__awaiter||function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(c){c(o)})}return new(n||(n=Promise))(function(o,c){function l(s){try{u(r.next(s))}catch(a){c(a)}}function f(s){try{u(r.throw(s))}catch(a){c(a)}}function u(s){s.done?o(s.value):i(s.value).then(l,f)}u((r=r.apply(e,t||[])).next())})};function re(e){return b(this,void 0,void 0,function*(){const t=e.toDataURL();return t==="data:,"?Promise.resolve(e.cloneNode(!1)):C(t)})}function ie(e,t){return b(this,void 0,void 0,function*(){return Promise.resolve(e.poster).then(n=>P(n,t)).then(n=>x(n.blob,v(e.poster)||n.contentType)).then(n=>C(n))})}function oe(e,t){return b(this,void 0,void 0,function*(){return e instanceof HTMLCanvasElement?re(e):e instanceof HTMLVideoElement&&e.poster?ie(e,t):Promise.resolve(e.cloneNode(!1))})}const ce=e=>e.tagName!=null&&e.tagName.toUpperCase()==="SLOT";function se(e,t,n){var r;return b(this,void 0,void 0,function*(){const i=ce(e)&&e.assignedNodes?m(e.assignedNodes()):m(((r=e.shadowRoot)!==null&&r!==void 0?r:e).childNodes);return i.length===0||e instanceof HTMLVideoElement?Promise.resolve(t):i.reduce((o,c)=>o.then(()=>U(c,n)).then(l=>{l&&t.appendChild(l)}),Promise.resolve()).then(()=>t)})}function ue(e,t){const n=window.getComputedStyle(e),r=t.style;!r||(n.cssText?r.cssText=n.cssText:m(n).forEach(i=>{r.setProperty(i,n.getPropertyValue(i),n.getPropertyPriority(i))}))}function le(e,t){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)}function fe(e,t){return b(this,void 0,void 0,function*(){return t instanceof Element?Promise.resolve().then(()=>ue(e,t)).then(()=>ne(e,t)).then(()=>le(e,t)).then(()=>t):Promise.resolve(t)})}function U(e,t,n){return b(this,void 0,void 0,function*(){return!n&&t.filter&&!t.filter(e)?Promise.resolve(null):Promise.resolve(e).then(r=>oe(r,t)).then(r=>se(e,r,t)).then(r=>fe(e,r))})}var ae=globalThis&&globalThis.__awaiter||function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(c){c(o)})}return new(n||(n=Promise))(function(o,c){function l(s){try{u(r.next(s))}catch(a){c(a)}}function f(s){try{u(r.throw(s))}catch(a){c(a)}}function u(s){s.done?o(s.value):i(s.value).then(l,f)}u((r=r.apply(e,t||[])).next())})};const k=/url\((['"]?)([^'"]+?)\1\)/g,he=/url\([^)]+\)\s*format\((["'])([^"']+)\1\)/g,de=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function me(e){const t=e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${t})(['"]?\\))`,"g")}function ge(e){const t=[];return e.replace(k,(n,r,i)=>(t.push(i),n)),t.filter(n=>!T(n))}function pe(e,t,n,r,i){const o=n?z(t,n):t;return Promise.resolve(o).then(c=>i?i(c):P(c,r)).then(c=>typeof c=="string"?x(c,v(t)):x(c.blob,v(t)||c.contentType)).then(c=>e.replace(me(t),`$1${c}$3`)).then(c=>c,()=>o)}function we(e,{preferredFontFormat:t}){return t?e.replace(de,n=>{for(;;){const[r,,i]=he.exec(n)||[];if(!i)return"";if(i===t)return`src: ${r};`}}):e}function F(e){return e.search(k)!==-1}function A(e,t,n){return ae(this,void 0,void 0,function*(){if(!F(e))return Promise.resolve(e);const r=we(e,n);return Promise.resolve(r).then(ge).then(i=>i.reduce((o,c)=>o.then(l=>pe(l,c,t,n)),Promise.resolve(r)))})}var E=globalThis&&globalThis.__awaiter||function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(c){c(o)})}return new(n||(n=Promise))(function(o,c){function l(s){try{u(r.next(s))}catch(a){c(a)}}function f(s){try{u(r.throw(s))}catch(a){c(a)}}function u(s){s.done?o(s.value):i(s.value).then(l,f)}u((r=r.apply(e,t||[])).next())})};function be(e,t){var n;return E(this,void 0,void 0,function*(){const r=(n=e.style)===null||n===void 0?void 0:n.getPropertyValue("background");return r?Promise.resolve(r).then(i=>A(i,null,t)).then(i=>(e.style.setProperty("background",i,e.style.getPropertyPriority("background")),e)):Promise.resolve(e)})}function ye(e,t){return E(this,void 0,void 0,function*(){if(!(e instanceof HTMLImageElement&&!T(e.src))&&!(e instanceof SVGImageElement&&!T(e.href.baseVal)))return Promise.resolve(e);const n=e instanceof HTMLImageElement?e.src:e.href.baseVal;return Promise.resolve(n).then(r=>P(r,t)).then(r=>x(r.blob,v(n)||r.contentType)).then(r=>new Promise((i,o)=>{e.onload=i,e.onerror=o,e instanceof HTMLImageElement?(e.srcset="",e.src=r):e.href.baseVal=r})).then(()=>e,()=>e)})}function ve(e,t){return E(this,void 0,void 0,function*(){const r=m(e.childNodes).map(i=>D(i,t));return Promise.all(r).then(()=>e)})}function D(e,t){return E(this,void 0,void 0,function*(){return e instanceof Element?Promise.resolve(e).then(n=>be(n,t)).then(n=>ye(n,t)).then(n=>ve(n,t)):Promise.resolve(e)})}function xe(e,t){const{style:n}=e;t.backgroundColor&&(n.backgroundColor=t.backgroundColor),t.width&&(n.width=`${t.width}px`),t.height&&(n.height=`${t.height}px`);const r=t.style;return r!=null&&Object.keys(r).forEach(i=>{n[i]=r[i]}),e}var y=globalThis&&globalThis.__awaiter||function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(c){c(o)})}return new(n||(n=Promise))(function(o,c){function l(s){try{u(r.next(s))}catch(a){c(a)}}function f(s){try{u(r.throw(s))}catch(a){c(a)}}function u(s){s.done?o(s.value):i(s.value).then(l,f)}u((r=r.apply(e,t||[])).next())})};const M={};function V(e){const t=M[e];if(t!=null)return t;const n=window.fetch(e).then(r=>({url:e,cssText:r.text()}));return M[e]=n,n}function H(e){return y(this,void 0,void 0,function*(){return e.cssText.then(t=>{let n=t;const r=/url\(["']?([^"')]+)["']?\)/g,o=(n.match(/url\([^)]+\)/g)||[]).map(c=>{let l=c.replace(r,"$1");return l.startsWith("https://")||(l=new URL(l,e.url).href),window.fetch(l).then(f=>f.blob()).then(f=>new Promise((u,s)=>{const a=new FileReader;a.onloadend=()=>{n=n.replace(c,`url(${a.result})`),u([c,a.result])},a.onerror=s,a.readAsDataURL(f)}))});return Promise.all(o).then(()=>n)})})}function O(e){if(e==null)return[];const t=[],n=/(\/\*[\s\S]*?\*\/)/gi;let r=e.replace(n,"");const i=new RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");for(;;){const f=i.exec(r);if(f===null)break;t.push(f[0])}r=r.replace(i,"");const o=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,c="((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})",l=new RegExp(c,"gi");for(;;){let f=o.exec(r);if(f===null){if(f=l.exec(r),f===null)break;o.lastIndex=l.lastIndex}else l.lastIndex=o.lastIndex;t.push(f[0])}return t}function Se(e){return y(this,void 0,void 0,function*(){const t=[],n=[];return e.forEach(r=>{if("cssRules"in r)try{m(r.cssRules).forEach((i,o)=>{if(i.type===CSSRule.IMPORT_RULE){let c=o+1;const l=i.href,f=V(l).then(u=>u?H(u):"").then(u=>O(u).forEach(s=>{try{r.insertRule(s,s.startsWith("@import")?c+=1:r.cssRules.length)}catch(a){console.error("Error inserting rule from remote css",{rule:s,error:a})}})).catch(u=>{console.error("Error loading remote css",u.toString())});n.push(f)}})}catch(i){const o=e.find(c=>c.href==null)||document.styleSheets[0];r.href!=null&&n.push(V(r.href).then(c=>c?H(c):"").then(c=>O(c).forEach(l=>{o.insertRule(l,r.cssRules.length)})).catch(c=>{console.error("Error loading remote stylesheet",c.toString())})),console.error("Error inlining remote css file",i.toString())}}),Promise.all(n).then(()=>(e.forEach(r=>{if("cssRules"in r)try{m(r.cssRules).forEach(i=>{t.push(i)})}catch(i){console.error(`Error while reading CSS rules from ${r.href}`,i.toString())}}),t))})}function Ee(e){return e.filter(t=>t.type===CSSRule.FONT_FACE_RULE).filter(t=>F(t.style.getPropertyValue("src")))}function Te(e){return y(this,void 0,void 0,function*(){return new Promise((t,n)=>{e.ownerDocument==null&&n(new Error("Provided element is not within a Document")),t(m(e.ownerDocument.styleSheets))}).then(t=>Se(t)).then(Ee)})}function Ce(e,t){return y(this,void 0,void 0,function*(){return Te(e).then(n=>Promise.all(n.map(r=>{const i=r.parentStyleSheet?r.parentStyleSheet.href:null;return A(r.cssText,i,t)}))).then(n=>n.join(`
`))})}function Re(e,t){return y(this,void 0,void 0,function*(){return(t.fontEmbedCSS!=null?Promise.resolve(t.fontEmbedCSS):Ce(e,t)).then(n=>{const r=document.createElement("style"),i=document.createTextNode(n);return r.appendChild(i),e.firstChild?e.insertBefore(r,e.firstChild):e.appendChild(r),e})})}var $=globalThis&&globalThis.__awaiter||function(e,t,n,r){function i(o){return o instanceof n?o:new n(function(c){c(o)})}return new(n||(n=Promise))(function(o,c){function l(s){try{u(r.next(s))}catch(a){c(a)}}function f(s){try{u(r.throw(s))}catch(a){c(a)}}function u(s){s.done?o(s.value):i(s.value).then(l,f)}u((r=r.apply(e,t||[])).next())})};function W(e,t={}){const n=t.width||q(e),r=t.height||K(e);return{width:n,height:r}}function Pe(e,t={}){return $(this,void 0,void 0,function*(){const{width:n,height:r}=W(e,t);return Promise.resolve(e).then(i=>U(i,t,!0)).then(i=>Re(i,t)).then(i=>D(i,t)).then(i=>xe(i,t)).then(i=>Y(i,n,r))})}const h=16384;function $e(e){(e.width>h||e.height>h)&&(e.width>h&&e.height>h?e.width>e.height?(e.height*=h/e.width,e.width=h):(e.width*=h/e.height,e.height=h):e.width>h?(e.height*=h/e.width,e.width=h):(e.width*=h/e.height,e.height=h))}function _e(e,t={}){return $(this,void 0,void 0,function*(){return Pe(e,t).then(C).then(n=>{const r=document.createElement("canvas"),i=r.getContext("2d"),o=t.pixelRatio||J(),{width:c,height:l}=W(e,t),f=t.canvasWidth||c,u=t.canvasHeight||l;return r.width=f*o,r.height=u*o,t.skipAutoScale||$e(r),r.style.width=`${f}`,r.style.height=`${u}`,t.backgroundColor&&(i.fillStyle=t.backgroundColor,i.fillRect(0,0,r.width,r.height)),i.drawImage(n,0,0,r.width,r.height),r})})}function Le(e,t={}){return $(this,void 0,void 0,function*(){return _e(e,t).then(n=>n.toDataURL())})}let g,d,_;function Ie(){g=document.createElement("video"),document.body.appendChild(g),d=document.createElement("button"),d.textContent="Enter PIP",d.onclick=()=>{g.requestPictureInPicture()},d.style.zIndex="100",d.style.position="absolute",d.style.top="10px",d.style.left="10px",d.style.width="100px",d.style.background="orange",document.body.appendChild(d),_=document.createElement("canvas")}function Ue(){Ie();const e=_.captureStream(1),t=new MediaRecorder(e);t.ondataavailable=ke;let n;setInterval(()=>{Le(document.body).then(r=>{t.start();const i=new Image;i.src=r;const o=_.getContext("2d");o.width=i.width,o.height=i.height,o.drawImage(i,0,0),clearTimeout(n),n=setTimeout(()=>{t.stop()},500)})},1e3)}function ke(e){console.log("Encoded");const t=new Blob([e.data]),n=URL.createObjectURL(t);g.controls=!0,g.style.position="absolute",g.style.width="20px",g.src=n,g.onended=function(){URL.revokeObjectURL(n)}}return Ue});
